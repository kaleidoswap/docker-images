version: '3.8'

services:
  bitcoind:
    image: kaleidoswap/mutinynet-bitcoind:latest
    platform: linux/amd64
    environment:
      - NETWORK=${NETWORK}
      - RPCAUTH=${RPCAUTH}
      - SIGNETCHALLENGE=${SIGNETCHALLENGE}
      - ADDNODE=${ADDNODE}
      - SIGNETBLOCKTIME=${SIGNETBLOCKTIME}
      - ADDR_TYPE=${ADDR_TYPE}
      - DNSSEED=${DNSSEED}
    networks:
      - kaleidoswap-network
    ports:
      - "28332:28332"
      - "28333:28333"
      - "29000:29000"
      - "38332:38332"
      - "38333:38333"
    volumes:
      - ./data/bitcoin:/srv/app/.bitcoin

  electrs:
    image: kaleidoswap/mutinynet-electrs:latest
    platform: linux/amd64
    environment:
      - BTCHOST=${BTCHOST}
      - BTCRPCPORT=${BTCRPCPORT}
      - BTCP2PPORT=${BTCP2PPORT}
      - BTCUSER=${BTCUSER}
      - BTCPASS=${BTCPASS}
      - PORT=${PORT}
      - MONITORING_PORT=${MONITORING_PORT}
      - NETWORK=${NETWORK}
      - LOG_LEVEL=${LOG_LEVEL}
      - SIGNET_MAGIC=${SIGNET_MAGIC}
    ports:
      - "50001:50001"
      - "34224:34224"
    networks:
      - kaleidoswap-network
    volumes:
      - ./data/electrs:/srv/app/db
    depends_on:
      - bitcoind

  proxy:
    image: ghcr.io/rgb-tools/rgb-proxy-server:0.3.0
    ports:
      - 3000:3000
    networks:
      - kaleidoswap-network
    
  rln-node:
    image: kaleidoswap/rgb-lightning-node:latest
    platform: linux/amd64
    command: >
      /tmp/kaleidoswap/dataldk1/  
      --daemon-listening-port 3001
      --ldk-peer-listening-port 9735
      --network ${NETWORK}
    depends_on:
      - bitcoind
      - electrs
    networks:
      - kaleidoswap-network
    ports:
      - 3001:3001
      - 9735:9735
    volumes:
      - ./data/rln-node:/tmp/kaleidoswap/dataldk3/
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/nodeinfo"]
      interval: 10s
      timeout: 5s
      retries: 5
    

networks:
  kaleidoswap-network:
    # Allow setting it to false for testing
    external: false